# Multi-stage optimized Asterisk Docker build
# Asterisk {{ version }} on {{ config.base.os|title }} {{ config.base.distribution }}
# Generated from YAML configuration - DO NOT EDIT MANUALLY

{% set build_opt = config.build.optimization | default({}) -%}
{% set docker_config = config.docker -%}
{% set user_config = docker_config.user | default({}) -%}
{% set base_image = config.base.image -%}
{% set slim_suffix = "-slim" if config.build.stages.runtime.slim | default(true) else "" -%}

# ==============================================================================
# STAGE 1: Build Environment
# ==============================================================================
FROM {{ base_image }} AS asterisk-builder

LABEL maintainer="{{ maintainer }}"
LABEL org.opencontainers.image.title="Asterisk PBX Builder"
LABEL org.opencontainers.image.description="Build stage for Asterisk {{ version }}"
LABEL org.opencontainers.image.version="{{ version }}"
LABEL org.opencontainers.image.source="https://github.com/andrius/asterisk-docker"

# Build arguments
ARG ASTERISK_VERSION={{ version }}
{% if config.asterisk.addons.version -%}
ARG ASTERISK_ADDONS_VERSION={{ config.asterisk.addons.version }}
{% endif -%}
ARG JOBS={{ build_opt.parallel_jobs | default("8") }}
ARG DEBIAN_FRONTEND=noninteractive

# Environment variables
ENV ASTERISK_VERSION=${ASTERISK_VERSION}
ENV DEBIAN_FRONTEND=${DEBIAN_FRONTEND}
{% if build_opt.cache_mounts | default(true) -%}
ENV TMPDIR="/tmp/asterisk_build"
{% endif %}

{% if config.base.os == "debian" -%}
# Create build directories first
RUN mkdir -p \
    /usr/src/asterisk \
{% if build_opt.cache_mounts | default(true) -%}
    ${TMPDIR} && \
    chmod 777 ${TMPDIR}
{% else -%}
    /tmp/asterisk_build
{% endif %}

# Update package lists and install ca-certificates first, then build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    apt-get install -y --no-install-recommends \
{{ build_packages | build_packages_without_ca | join_packages(80) }} && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    mkdir -p ${TMPDIR} && chmod 777 ${TMPDIR}
{% elif config.base.os == "alpine" -%}
# Install build dependencies
RUN apk add --no-cache --virtual .build-deps \
{{ build_packages | join_packages(80) }}
{% endif %}

{% if config.base.os == "alpine" -%}
# Create build directories and set permissions
RUN mkdir -p \
    /usr/src/asterisk \
{% if config.asterisk.addons.version -%}
    /usr/src/asterisk/addons \
{% endif -%}
{% if build_opt.cache_mounts | default(true) -%}
    ${TMPDIR} && \
    chmod 777 ${TMPDIR}
{% else -%}
    /tmp/asterisk_build
{% endif %}
{% endif %}

WORKDIR /usr/src/asterisk

# Download and extract Asterisk source
{% set source_url = config.asterisk.source.url_template | default("http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-{version}.tar.gz") -%}
RUN curl -fsSL {{ source_url.format(version=version) }} | \
    tar --strip-components=1 -xz

{% if config.asterisk.addons.version -%}
# Download and extract Asterisk addons (for legacy versions)
WORKDIR /usr/src/asterisk/addons
{% set addons_url = config.asterisk.addons.url_template | default("http://downloads.asterisk.org/pub/telephony/asterisk/old-releases/asterisk-addons-{version}.tar.gz") -%}
RUN curl -fsSL {{ addons_url.format(version=config.asterisk.addons.version) }} | \
    tar --strip-components=1 -xz

WORKDIR /usr/src/asterisk
{% endif %}

# Configure Asterisk build
{% if configure_options -%}
RUN ./configure \
{% for option in configure_options -%}
    {{ option }}{% if not loop.last %} \{% endif %}

{% endfor %}
{% else -%}
RUN ./configure
{% endif %}

# Generate menuselect configuration
RUN make menuselect/menuselect menuselect-tree menuselect.makeopts

{% if config.base.os == "debian" -%}
# Optimize build configuration for smaller image
RUN sed -i 's/HAVE_XML2 = yes/HAVE_XML2 = no/' makeopts && \
    sed -i 's/HAVE_XMLSTARLET = yes/HAVE_XMLSTARLET = no/' makeopts
{% endif %}

# Copy and execute build script
COPY build.sh /usr/src/asterisk/build.sh
RUN chmod +x build.sh && ./build.sh

# ==============================================================================
# STAGE 2: Runtime Environment
# ==============================================================================
FROM {{ base_image }}{{ slim_suffix }} AS asterisk-runtime

LABEL maintainer="{{ maintainer }}"
LABEL org.opencontainers.image.title="Asterisk PBX Runtime"
LABEL org.opencontainers.image.description="Runtime environment for Asterisk {{ version }}"

ARG DEBIAN_FRONTEND=noninteractive
ENV DEBIAN_FRONTEND=${DEBIAN_FRONTEND}

{% if config.base.os == "debian" -%}
# Install only runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
{{ runtime_packages | join_packages(80) }} && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
{% elif config.base.os == "alpine" -%}
# Install runtime dependencies
RUN apk add --no-cache \
{{ runtime_packages | join_packages(80) }}
{% endif %}

# Create asterisk user and required directories
RUN useradd --uid {{ user_config.uid | default(1000) }} --system --user-group \
    --home-dir {{ user_config.home | default("/home/asterisk") }} --create-home \
    {{ user_config.name | default("asterisk") }} && \
    mkdir -p \
    /var/run/asterisk \
    /var/log/asterisk \
    /var/spool/asterisk/monitor \
    /var/spool/asterisk/outgoing \
    /var/spool/asterisk/tmp \
    /var/spool/asterisk/voicemail \
    /var/spool/asterisk/fax \
    /var/lib/asterisk/keys \
    /var/lib/asterisk/phoneprov \
    /var/lib/asterisk/sounds \
    /var/lib/asterisk/docs

# ==============================================================================
# STAGE 3: Final Production Image
# ==============================================================================
FROM asterisk-runtime AS asterisk-production

# Copy Asterisk binaries and configurations from builder
COPY --from=asterisk-builder /usr/sbin/asterisk /usr/sbin/asterisk
COPY --from=asterisk-builder /usr/lib/asterisk /usr/lib/asterisk
COPY --from=asterisk-builder /var/lib/asterisk /var/lib/asterisk
COPY --from=asterisk-builder /etc/asterisk /etc/asterisk

# Copy Asterisk shared libraries
COPY --from=asterisk-builder /usr/lib/libasterisk*.so* /usr/lib/

{% if docker_config.healthcheck.enabled | default(true) -%}
# Copy healthcheck script
COPY healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/healthcheck.sh
{% endif %}

# Set proper ownership and permissions
RUN chown -R {{ user_config.name | default("asterisk") }}:{{ user_config.name | default("asterisk") }} \
    /etc/asterisk \
    {{ user_config.home | default("/home/asterisk") }} \
    /var/run/asterisk \
    /var/log/asterisk \
    /var/spool/asterisk \
    /var/lib/asterisk && \
    chmod -R 750 /var/spool/asterisk

# Runtime verification
RUN asterisk -V || (echo "Error: Unable to run asterisk -V" && exit 1)

# Configure networking
{% for port in docker_config.networking.ports | default(["5060/udp", "5060/tcp", "5061/tcp", "10000-10099/udp"]) -%}
EXPOSE {{ port }}
{% endfor %}

# Define volumes for persistent data
{% if docker_config.volumes -%}
VOLUME [{% for volume in docker_config.volumes %}"{{ volume }}"{% if not loop.last %}, {% endif %}{% endfor %}]
{% endif %}

{% if docker_config.healthcheck.enabled | default(true) -%}
# Add health check
HEALTHCHECK --interval={{ docker_config.healthcheck.interval | default("30s") }} \
    --timeout={{ docker_config.healthcheck.timeout | default("10s") }} \
    --start-period={{ docker_config.healthcheck.start_period | default("30s") }} \
    --retries={{ docker_config.healthcheck.retries | default(3) }} \
    CMD {{ docker_config.healthcheck.command | default("/usr/local/bin/healthcheck.sh") }}
{% endif %}

# Switch to non-root user
USER {{ user_config.name | default("asterisk") }}

# Set working directory
WORKDIR {{ user_config.home | default("/home/asterisk") }}

# Default command with production settings
CMD ["/usr/sbin/asterisk", "-vvvdddf", "-T", "-W", "-U", "{{ user_config.name | default("asterisk") }}", "-p"]