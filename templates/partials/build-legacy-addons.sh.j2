#!/bin/bash
# Legacy Asterisk build script with addons support
# For versions 1.2, 1.4, 1.6 that require asterisk-addons
# Based on working andrius-asterisk build approach
# Generated from template for {{ config.version }}

set -euo pipefail

log() {
    echo -e "\033[0;32m[BUILD]\033[0m $1"
}

warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

log "Starting legacy Asterisk {{ config.version }} build process with addons..."

# Set build parallelization
NPROC=$(nproc)
JOBS=${JOBS:-$(( $NPROC + $NPROC / 2 ))}
log "Using $JOBS parallel jobs for compilation (detected $NPROC CPUs)"

# Create directories for Asterisk and addons
mkdir -p /usr/src/asterisk \
         /usr/src/asterisk/addons \
         /etc/asterisk \
         /var/spool/asterisk/fax

# Download and extract addons first
log "Downloading and extracting asterisk-addons..."
cd /usr/src/asterisk/addons
curl -vsL {{ config.asterisk.addons.url_template.replace('{version}', config.asterisk.addons.version) }} | tar --strip-components 1 -xz

# Return to main Asterisk directory
cd /usr/src/asterisk

# Minimal menuselect configuration (legacy approach - skip for very old versions)
{% set major_version = config.version.split('.')[0] | int -%}
{% set minor_version = config.version.split('.')[1] | int -%}
{% set is_very_old = (major_version == 1 and minor_version < 4) -%}
{% if not is_very_old -%}
log "Configuring Asterisk modules with minimal approach..."

# Disable sound categories to reduce image size
menuselect/menuselect --disable-category MENUSELECT_CORE_SOUNDS menuselect.makeopts
menuselect/menuselect --disable-category MENUSELECT_MOH menuselect.makeopts
menuselect/menuselect --disable-category MENUSELECT_EXTRA_SOUNDS menuselect.makeopts

log "Module configuration completed (minimal approach - let Asterisk choose defaults)"
{% else -%}
log "Skipping menuselect configuration for very old Asterisk version ({{ config.version }})"
{% endif %}

# Build main Asterisk first
log "Building Asterisk core (this may take several minutes)..."
{% if config.version.startswith('1.2') -%}
# For very old versions, try compatibility fixes for compilation issues
log "Applying compatibility fixes for very old Asterisk version"
# Remove problematic channel source files that conflict with modern headers
if [ -f "channels/chan_alsa.c" ]; then
    log "Removing chan_alsa.c to avoid pollfd conflicts"
    mv channels/chan_alsa.c channels/chan_alsa.c.disabled
    # Also remove from Makefile
    sed -i 's/chan_alsa\.c//g' channels/Makefile
    sed -i 's/chan_alsa\.so//g' channels/Makefile
fi
# Remove problematic IAX2 modules that have inline function conflicts
if [ -f "channels/iax2-provision.c" ]; then
    log "Removing iax2-provision.c to avoid multiple definition conflicts"
    mv channels/iax2-provision.c channels/iax2-provision.c.disabled
    sed -i 's/iax2-provision\.c//g' channels/Makefile
    sed -i 's/iax2-provision\.o//g' channels/Makefile
fi
# Set compatibility compiler flags for old GCC inline function handling
export CFLAGS="${CFLAGS:-} -DPOLLCOMPAT_FORCE -fgnu89-inline -std=gnu89"
{% endif -%}
make -j $JOBS all
log "Installing Asterisk..."
make install

# Copy default configs and clean up
log "Installing sample configurations..."
make samples
{% if config.version.startswith('1.2') -%}
# Very old versions don't have dist-clean target, use clean instead
make clean || true
{% else -%}
make dist-clean
{% endif -%}

# Set runuser and rungroup
sed -i -E 's/^;(run)(user|group)/\1\2/' /etc/asterisk/asterisk.conf
sed -i -e 's/# MAXFILES=/MAXFILES=/' /usr/sbin/safe_asterisk

# Build and install addons
log "Building and installing asterisk-addons..."
cd /usr/src/asterisk/addons

{% if config.version.startswith('1.2') -%}
# Very old addons versions don't have configure script
log "Skipping configure for very old asterisk-addons version"
{% else -%}
# Configure addons with same libdir
./configure --libdir=/usr/lib64
make menuselect/menuselect menuselect-tree menuselect.makeopts
{% endif -%}

# Build and install addons
make -j $JOBS all
make install
{% if config.version.startswith('1.2') -%}
# Very old addons versions don't have samples target
log "Skipping samples for very old asterisk-addons version"
{% else -%}
make samples
{% endif -%}

# Fix permissions (ownership handled by Dockerfile STAGE 3)
chmod -R 755 /var/spool/asterisk

# Clean up source directories
cd /
rm -rf /usr/src/asterisk

# Strip binaries to reduce size
log "Stripping binaries to reduce image size..."
find /usr/sbin /usr/lib64/asterisk -type f -executable \
    -exec strip --strip-unneeded {} + 2>/dev/null || true

log "Legacy Asterisk {{ config.version }} with addons build completed successfully!"